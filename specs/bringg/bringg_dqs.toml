[[queries]]
name = "BBuy query - Amit test - task group"
statement = '''
  with wp2 as (
  select
    task_id,
    no_earlier_than
  from
    way_points wp
  where
    merchant_id = 2288
    AND position = 2
    and (
      (
        "wp"."no_earlier_than" is not null
        or "wp"."no_later_than" is not null
      )
      and (
        "wp"."no_earlier_than" is null
        or "wp"."no_earlier_than" >= '2025-09-26T22:00:00.000Z'
      )
      and (
        "wp"."no_later_than" is null
        or "wp"."no_later_than" <= '2025-10-03T21:59:59.999Z'
      )
    )
    or (
      "wp"."scheduled_at" is not null
      and "wp"."no_earlier_than" is null
      and "wp"."no_later_than" is null
      and "wp"."scheduled_at" >= '2025-09-26T22:00:00.000Z'
      and "wp"."scheduled_at" <= '2025-10-03T21:59:59.999Z'
    )
),
base_tasks as (
  select
    id,
    run_id,
    team_id,
    user_id
  from
    tasks
  where
    merchant_id = 2288
    and delete_at is null
    and status in (0, 1, 2, 3, 5, 6, 9, 10)
    and team_id in (215472, 213290, 213291, 211587)
    and not ready_to_execute = true
    and service_plan_id in (1330, 1609, 1610, 1325)
    and '60288_Refrigerator Delivery Only' = any(required_skills)
    and '60274_Refrigeration Install Premium - Plumbing' = any(required_skills)
    and id in (
      select
        task_id
      from
        wp2
    )
),
"inner_tasks_query" as (
  select
    "tasks"."id",
    "users"."name" as "user_name",
    "users"."id" as "user_id",
    "teams"."name" as "main_group_sort_value",
    "teams"."name" as "team_name",
    "teams"."id" as "team_id",
    "tasks"."run_id" as "route_id",
    CASE
      WHEN runs.id is null THEN null
      WHEN planned_routes.title IS NULL
      AND service_areas.name is NULL THEN concat('Route-', runs.id)
      WHEN planned_routes.title IS NOT NULL
      AND service_areas.name is not null THEN concat(planned_routes.title, '-', service_areas.name)
      WHEN planned_routes.title IS NOT NULL THEN planned_routes.title
      ELSE service_areas.name
    END as route_name,
    CAST(
      COALESCE(runs.started_at, runs.scheduled_start_time) AS TIMESTAMP
    ) as secondary_group_sort_value,
    CAST(
      COALESCE(runs.started_at, runs.scheduled_start_time) AS TIMESTAMP
    ) as route_start_time
  from
    base_tasks as "tasks"
    left join "runs" on "runs"."id" = "tasks"."run_id"
    and runs.merchant_id = 2288
    left join "users" on "users"."id" = "tasks"."user_id"
    and users.merchant_id = 2288
    and driver = true
    left join "planned_routes" on "runs"."planned_route_id" = "planned_routes"."id"
    and planned_routes.merchant_id = 2288
    left join "service_areas" on "runs"."service_area_id" = "service_areas"."id"
    and service_areas.merchant_id = 2288
    left join "teams" on "teams"."id" = "tasks"."team_id"
    and teams.merchant_id = 2288
)
select
  "team_name",
  "team_name" as "main_group_sort_value",
  "route_start_time" as "secondary_group_sort_value",
  max(team_id) as team_id,
  "route_start_time",
  max(route_name) as route_name,
  max(route_id) as route_id,
  count(*) as count_per_sub
from
  "inner_tasks_query"
group by
  "team_name",
  "team_id",
  "route_start_time",
  "route_id"
order by
  "team_name" asc,
  "team_id" asc,
  "route_start_time" asc,
  "route_id" asc
limit
  1000;

'''
iterations = 100
concurrency = 2

[[queries]]
name = "BBuy query - Amit test - task"
statement = '''
  with wp2 as (
  select
    task_id,
    no_earlier_than
  from
    way_points wp
  where
    merchant_id = 2288
    AND position = 2
    and (
      (
        "wp"."no_earlier_than" is not null
        or "wp"."no_later_than" is not null
      )
      and (
        "wp"."no_earlier_than" is null
        or "wp"."no_earlier_than" >= '2025-09-26T22:00:00.000Z'
      )
      and (
        "wp"."no_later_than" is null
        or "wp"."no_later_than" <= '2025-10-03T21:59:59.999Z'
      )
    )
    or (
      "wp"."scheduled_at" is not null
      and "wp"."no_earlier_than" is null
      and "wp"."no_later_than" is null
      and "wp"."scheduled_at" >= '2025-09-26T22:00:00.000Z'
      and "wp"."scheduled_at" <= '2025-10-03T21:59:59.999Z'
    )
),
base_tasks as (
  select
    id,
    run_id,
    team_id,
    user_id
  from
    tasks
  where
    merchant_id = 2288
    and delete_at is null
    and status in (0, 1, 2, 3, 5, 6, 9, 10)
    and team_id in (215472, 213290, 213291, 211587)
    and not ready_to_execute = true
    and service_plan_id in (1330, 1609, 1610, 1325)
    and '60288_Refrigerator Delivery Only' = any(required_skills)
    and '60274_Refrigeration Install Premium - Plumbing' = any(required_skills)
    and id in (
        select
          task_id
        from
          wp2
      )
    and (
      "tasks"."group_uuid" is null
      or (
        "tasks"."group_uuid" is not null
        and "tasks"."group_leader_id" is null
      )
    )
)
select
  *,
  "id" as "sort_value",
  "team_name" as "main_group_sort_value",
  "route_start_time" as "secondary_group_sort_value"
from
  (
    select
      "tasks"."id",
      "users"."name" as "user_name",
      "users"."id" as "user_id",
      "teams"."name" as "team_name",
      "teams"."id" as "team_id",
      "tasks"."run_id" as "route_id",
      CASE
        WHEN runs.id is null THEN null
        WHEN planned_routes.title IS NULL
        AND service_areas.name is NULL THEN concat('Route-', runs.id)
        WHEN planned_routes.title IS NOT NULL
        AND service_areas.name is not null THEN concat(planned_routes.title, '-', service_areas.name)
        WHEN planned_routes.title IS NOT NULL THEN planned_routes.title
        ELSE service_areas.name
      END as route_name,
      CAST(
        COALESCE(runs.started_at, runs.scheduled_start_time) AS TIMESTAMP
      ) as route_start_time
    from
      base_tasks as "tasks"
      left join "runs" on "runs"."id" = "tasks"."run_id"
      and runs.merchant_id = 2288
      left join "users" on "users"."id" = "tasks"."user_id"
      and users.merchant_id = 2288
      and driver = true
      left join "planned_routes" on "runs"."planned_route_id" = "planned_routes"."id"
      and planned_routes.merchant_id = 2288
      left join "service_areas" on "runs"."service_area_id" = "service_areas"."id"
      and service_areas.merchant_id = 2288
      left join "teams" on "teams"."id" = "tasks"."team_id"
      and teams.merchant_id = 2288
  order by
    "id" asc
  limit
    100
  ) as "tasks";
'''
iterations = 100
concurrency = 2


[[queries]]
name = "BBuy 15 teams no time window - task group"
statement = '''
  with base_tasks as (
  select
    id,
    run_id,
    team_id,
    user_id
  from
    tasks
  where
    (
      "tasks"."merchant_id" = 2288
      and "tasks"."delete_at" is null
      and "tasks"."group_leader_id" is null
      and "tasks"."status" in (0, 1, 2, 3, 5, 6, 9, 10)
      and (
        (
          "tasks"."team_id" in (
            213290,
            212548,
            213532,
            213531,
            217140,
            213283,
            213540,
            213293,
            213525,
            213535,
            213538,
            213934,
            213288,
            213539,
            213289
          )
        )
        and (not "tasks"."ready_to_execute" = true)
      )
    )
),
"inner_tasks_query" as (
  select
    *,
    "team_name" as "main_group_sort_value",
    "route_start_time" as "secondary_group_sort_value"
  from
    (
      select
        "tasks"."id",
        "users"."name" as "user_name",
        "users"."id" as "user_id",
        "teams"."name" as "team_name",
        "teams"."id" as "team_id",
        "tasks"."run_id" as "route_id",
        CASE
          WHEN runs.id is null THEN null
          WHEN planned_routes.title IS NULL
          AND service_areas.name is NULL THEN concat('Route-', runs.id)
          WHEN planned_routes.title IS NOT NULL
          AND service_areas.name is not null THEN concat(planned_routes.title, '-', service_areas.name)
          WHEN planned_routes.title IS NOT NULL THEN planned_routes.title
          ELSE service_areas.name
        END as route_name,
        cast(
          COALESCE(runs.started_at, runs.scheduled_start_time) as timestamp
        ) as route_start_time
      from
        base_tasks as "tasks"
        left join "runs" on "runs"."id" = "tasks"."run_id"
        and runs.merchant_id = 2288
        left join "users" on "users"."id" = "tasks"."user_id"
        and users.merchant_id = 2288
        and driver = true
        left join "planned_routes" on "runs"."planned_route_id" = "planned_routes"."id"
        and planned_routes.merchant_id = 2288
        left join "service_areas" on "runs"."service_area_id" = "service_areas"."id"
        and service_areas.merchant_id = 2288
        left join "teams" on "teams"."id" = "tasks"."team_id"
        and teams.merchant_id = 2288      
    ) as "tasks"
)
select
  *,
  "team_name" as "main_group_sort_value",
  "route_start_time" as "secondary_group_sort_value"
from
  (
    select
      "team_name",
      max(team_id) as team_id,
      "route_start_time",
      max(route_name) as route_name,
      max(route_id) as route_id,
      count(*) as count_per_sub,
      sum(count(*)) over (partition by team_name, team_id) as count_per_group
    from
      "inner_tasks_query"
    group by
      "team_name",
      "team_id",
      "route_start_time",
      "route_id"
    order by
      "team_name" asc,
      "team_id" asc,
      "route_start_time" asc,
      "route_id" asc
  ) as "subquery"
limit
  1000
'''
iterations = 100
concurrency = 2

[[queries]]
name = "BBuy 15 teams no time window - task"
statement = '''
  with base_tasks as (
  select
    id,
    run_id,
    team_id,
    user_id,
    external_id
  from
    tasks
  where
    (
      "tasks"."merchant_id" = 2288
      and "tasks"."delete_at" is null
      and (
        "tasks"."group_uuid" is null
        or (
          "tasks"."group_uuid" is not null
          and "tasks"."group_leader_id" is null
        )
      )
      and "tasks"."status" in (0, 1, 2, 3, 5, 6, 9, 10)
      and "tasks"."team_id" in (
        213290,
        212548,
        213532,
        213531,
        217140,
        213283,
        213540,
        213293,
        213525,
        213535,
        213538,
        213934,
        213288,
        213539,
        213289
      )
      and not "tasks"."ready_to_execute" = true
    )
)
select
  *,
  "external_id" as "sort_value",
  "team_name" as "main_group_sort_value",
  "route_start_time" as "secondary_group_sort_value"
from
  (
    select
      "tasks"."id",
      "users"."name" as "user_name",
      "users"."id" as "user_id",
      "teams"."name" as "team_name",
      "teams"."id" as "team_id",
      "tasks"."run_id" as "route_id",
      CASE
        WHEN runs.id is null THEN null
        WHEN planned_routes.title IS NULL
        AND service_areas.name is NULL THEN concat('Route-', runs.id)
        WHEN planned_routes.title IS NOT NULL
        AND service_areas.name is not null THEN concat(planned_routes.title, '-', service_areas.name)
        WHEN planned_routes.title IS NOT NULL THEN planned_routes.title
        ELSE service_areas.name
      END as route_name,
      CAST(
        COALESCE(runs.started_at, runs.scheduled_start_time) AS TIMESTAMP
      ) as route_start_time,
      "tasks"."external_id"
    from
      base_tasks as "tasks"
      left join "runs" on "runs"."id" = "tasks"."run_id"
      and runs.merchant_id = 2288
      left join "users" on "users"."id" = "tasks"."user_id"
      and users.merchant_id = 2288
      and driver = true
      left join "planned_routes" on "runs"."planned_route_id" = "planned_routes"."id"
      and planned_routes.merchant_id = 2288
      left join "service_areas" on "runs"."service_area_id" = "service_areas"."id"
      and service_areas.merchant_id = 2288
      left join "teams" on "teams"."id" = "tasks"."team_id"
      and teams.merchant_id = 2288
  order by
    "external_id" asc,
    "tasks"."id" asc
  limit
    100
  ) as "tasks";
'''
iterations = 100
concurrency = 2

[[queries]]
name = "BBuy all teams 24 hours - task_group"
statement = '''
with wp2 as (
  select
    task_id,
    no_earlier_than
  from
    way_points wp
  where
    merchant_id = 2288
    AND position = 2
    and (
      (
        "wp"."no_earlier_than" is not null
        or "wp"."no_later_than" is not null
      )
      and (
        "wp"."no_earlier_than" is null
        or "wp"."no_earlier_than" >= '2025-09-23T04:00:00.000Z'
      )
      and (
        "wp"."no_later_than" is null
        or "wp"."no_later_than" <= '2025-09-24T03:59:59.999Z'
      )
    )
    or (
      "wp"."scheduled_at" is not null
      and "wp"."no_earlier_than" is null
      and "wp"."no_later_than" is null
      and "wp"."scheduled_at" >= '2025-09-23T04:00:00.000Z'
      and "wp"."scheduled_at" <= '2025-09-24T03:59:59.999Z'
    )
),
base_tasks as (
  select
    id,
    run_id,
    team_id,
    user_id
  from
    tasks
  where
    (
      "tasks"."merchant_id" = 2288
      and "tasks"."delete_at" is null
      and (
        "tasks"."group_uuid" is null
        or (
          "tasks"."group_uuid" is not null
          and "tasks"."group_leader_id" is null
        )
      )
      and "tasks"."status" in (0, 1, 2, 3, 5, 6, 9, 10)
      and (
        "tasks"."team_id" is null
        or "tasks"."team_id" in (
          217228,
          217478,
          214208,
          213291,
          221926,
          214691,
          212372,
          217207,
          214761,
          212251,
          215508,
          214646,
          212247,
          214642,
          212246,
          214640,
          212245,
          214639,
          214759,
          214757,
          212363,
          214755,
          212361,
          212359,
          217203,
          212355,
          214752,
          214629,
          214631,
          212353,
          212352,
          212222,
          215485,
          217164,
          212265,
          214746,
          212340,
          214740,
          214739,
          214737,
          217477,
          214736,
          212338,
          214735,
          217202,
          212337,
          214734,
          215592,
          214727,
          212332,
          214725,
          214169,
          214171,
          212330,
          212329,
          217196,
          215589,
          215662,
          214723,
          212328,
          217195,
          214721,
          215581,
          214720,
          214719,
          217190,
          217189,
          214718,
          212326,
          217188,
          214172,
          212324,
          215575,
          217142,
          212263,
          212262,
          217141,
          212323,
          217185,
          214701,
          214698,
          212208,
          217160,
          214697,
          212321,
          214696,
          214173,
          212319,
          217184,
          212318,
          214695,
          212317,
          217183,
          214694,
          214182,
          217182,
          212257,
          217138,
          212207,
          215481,
          212204,
          217159,
          212203,
          214613,
          215475,
          212196,
          214612,
          214167,
          212195,
          212194,
          215474,
          212193,
          215473,
          212312,
          217181,
          212310,
          217180,
          214690,
          214689,
          212307,
          217178,
          212306,
          214685,
          215566,
          212303,
          217177,
          212302,
          217176,
          214676,
          214670,
          212190,
          217154,
          212187,
          215562,
          215561,
          215560,
          215559,
          214667,
          215558,
          212183,
          217151,
          212182,
          212181,
          212180,
          214597,
          212179,
          212178,
          212177,
          212176,
          217150,
          212174,
          214591,
          212169,
          214588,
          212168,
          214587,
          212296,
          217172,
          212295,
          212294,
          215552,
          212293,
          217171,
          212292,
          215549,
          212291,
          212167,
          214586,
          212166,
          214585,
          214654,
          215541,
          212290,
          214650,
          212165,
          214584,
          215538,
          214181,
          214180,
          214179,
          214178,
          214177,
          214175,
          215510,
          212252,
          212277,
          214814,
          212274,
          214783,
          212379,
          212378,
          212376,
          214828,
          212155,
          212152,
          215465,
          212249,
          212297,
          212228,
          212308,
          212300,
          212339,
          215010,
          215502,
          212164,
          214623,
          220867,
          214717,
          215483,
          212305,
          214637,
          214748,
          214745,
          214617,
          214603,
          213286,
          215469,
          214772,
          214773,
          214168,
          217193,
          214771,
          217186,
          214839,
          214705,
          214707,
          215582,
          215520,
          214809,
          212345,
          212304,
          217956,
          217957,
          214662,
          214656,
          212218,
          214820,
          211594,
          214665,
          212236,
          211592,
          212235,
          217958,
          214578,
          214788,
          212309,
          212333,
          214806,
          214635,
          214621,
          214747,
          214838,
          214687,
          214683,
          214835,
          212162,
          214804,
          214797,
          214785,
          214781,
          214700,
          214648,
          214583,
          214821,
          214641,
          214758,
          214624,
          194513,
          214183,
          214184,
          217208,
          217169,
          217206,
          217205,
          217204,
          217166,
          217201,
          217200,
          217199,
          217198,
          217132,
          217197,
          217194,
          217192,
          217191,
          217187,
          217162,
          217161,
          217139,
          217158,
          217175,
          217157,
          217156,
          217155,
          217152,
          217174,
          217173,
          217149,
          217170,
          217135,
          217129,
          217148,
          217145,
          217179,
          217168,
          217167,
          217165,
          217163,
          217153,
          217147,
          217144,
          217143,
          217140,
          217137,
          217136,
          217134,
          217133,
          217131,
          217130,
          216970,
          216972,
          216971,
          213664,
          211595,
          211593,
          211600,
          212266,
          214592,
          214593,
          214607,
          215772,
          194509,
          214770,
          214769,
          214659,
          214645,
          214742,
          212298,
          214630,
          214768,
          214628,
          215517,
          215638,
          215637,
          215636,
          215635,
          215634,
          215621,
          215620,
          215619,
          215244,
          215601,
          215600,
          215599,
          215598,
          215597,
          215596,
          215595,
          215594,
          215593,
          215591,
          215590,
          215588,
          215587,
          215586,
          215585,
          215584,
          215583,
          215580,
          215579,
          215578,
          215577,
          215576,
          215574,
          215573,
          215572,
          215571,
          215102,
          215094,
          214743,
          214744,
          214616,
          214576,
          214581,
          214780,
          212375,
          212374,
          214751,
          214680,
          214807,
          214802,
          214795,
          214799,
          214786,
          214778,
          214777,
          212264,
          214811,
          214810,
          214808,
          214805,
          214803,
          214801,
          214800,
          214798,
          214796,
          214794,
          214793,
          214792,
          214791,
          214790,
          214789,
          214787,
          214784,
          214782,
          214779,
          214776,
          214775,
          214774,
          214766,
          214765,
          214764,
          214763,
          214762,
          214760,
          214756,
          214754,
          214753,
          214750,
          214749,
          214741,
          214738,
          214733,
          214732,
          214731,
          214730,
          214729,
          214728,
          214726,
          214724,
          214722,
          214716,
          214715,
          214714,
          214713,
          214712,
          214711,
          214710,
          214709,
          214708,
          214767,
          217146,
          217128,
          212270,
          221450,
          212299,
          212316,
          212313,
          212289,
          212197,
          214706,
          214704,
          214703,
          214699,
          214693,
          214692,
          214688,
          214686,
          214684,
          214682,
          214681,
          214679,
          214678,
          214677,
          214675,
          214674,
          214673,
          214672,
          214671,
          214669,
          214668,
          214666,
          214664,
          214663,
          214661,
          214660,
          214658,
          214657,
          214655,
          214653,
          214652,
          214651,
          214649,
          214647,
          214644,
          214643,
          214638,
          214636,
          214634,
          214633,
          214627,
          214626,
          214625,
          214622,
          214620,
          214619,
          214618,
          214615,
          214614,
          214611,
          214610,
          214609,
          214608,
          214605,
          214604,
          214601,
          214600,
          214599,
          214598,
          214596,
          214595,
          214594,
          214590,
          214589,
          214579,
          214577,
          214575,
          214574,
          214573,
          214572,
          214170,
          214174,
          214186,
          214185,
          213648,
          213646,
          214176,
          213287,
          212552,
          213937,
          213282,
          213292,
          212550,
          213535,
          213543,
          213935,
          213533,
          212549,
          212551,
          213293,
          213934,
          213290,
          213284,
          213288,
          212548,
          213294,
          213289,
          213536,
          213540,
          213539,
          213537,
          211590,
          211589,
          211587,
          211588,
          211601,
          211596,
          211597,
          194517,
          213936,
          213647,
          213538,
          213532,
          212547,
          213948,
          212163,
          213542,
          213534,
          213665,
          213541,
          213531,
          213530,
          213529,
          213528,
          213527,
          213526,
          213525,
          213283,
          213285,
          215570,
          215569,
          215568,
          215567,
          215565,
          215564,
          215563,
          215557,
          215556,
          215555,
          215554,
          215553,
          215551,
          215550,
          215548,
          215547,
          215546,
          215545,
          215544,
          215543,
          215542,
          215540,
          215539,
          215537,
          215536,
          215535,
          215534,
          215533,
          215532,
          215531,
          215530,
          215529,
          215528,
          215527,
          215526,
          215525,
          215524,
          215523,
          215522,
          215521,
          215519,
          215518,
          215516,
          215515,
          215514,
          215513,
          215512,
          215511,
          215509,
          215507,
          215506,
          215505,
          215504,
          215503,
          215501,
          215500,
          215499,
          215498,
          215497,
          215496,
          215495,
          215494,
          215493,
          215492,
          215491,
          215490,
          215489,
          215488,
          215487,
          215486,
          215484,
          215482,
          215480,
          215479,
          215478,
          215477,
          215476,
          215472,
          215471,
          215470,
          215468,
          215467,
          215466,
          214582,
          214702,
          214580,
          211598,
          215101,
          215100,
          215099,
          215098,
          215097,
          215096,
          215095,
          214602,
          214632,
          214606,
          214843,
          214842,
          214841,
          214840,
          214837,
          214836,
          214834,
          214833,
          214832,
          214831,
          214830,
          214829,
          214827,
          214826,
          214825,
          214824,
          214823,
          214822,
          214819,
          214818,
          214817,
          214816,
          214815,
          214813,
          214812,
          211591,
          212273,
          212380,
          212377,
          212373,
          212371,
          212370,
          212369,
          212368,
          212367,
          212366,
          212365,
          212364,
          212362,
          212360,
          212358,
          212357,
          212356,
          212354,
          212351,
          212350,
          212349,
          212347,
          212346,
          212344,
          212343,
          212342,
          212341,
          212336,
          212335,
          212334,
          212331,
          212327,
          212325,
          212322,
          212320,
          212315,
          212314,
          212311,
          212301,
          212288,
          212287,
          212286,
          212285,
          212284,
          212283,
          212282,
          212281,
          212280,
          212279,
          212278,
          212276,
          212275,
          212272,
          212271,
          212269,
          212268,
          212267,
          212261,
          212260,
          212259,
          212258,
          212256,
          212255,
          212254,
          212253,
          212250,
          212248,
          212244,
          212243,
          212242,
          212241,
          212240,
          212239,
          212238,
          212237,
          212234,
          212233,
          212232,
          212231,
          212230,
          212229,
          212227,
          212226,
          212225,
          212224,
          212223,
          212221,
          212220,
          212219,
          212217,
          212216,
          212215,
          212214,
          212213,
          212212,
          212211,
          212210,
          212209,
          212206,
          212205,
          212202,
          212201,
          212200,
          212199,
          212198,
          212192,
          212191,
          212189,
          212188,
          212186,
          212185,
          212184,
          212175,
          212173,
          212172,
          212171,
          212170,
          212161,
          212160,
          212159,
          212158,
          212157,
          212156,
          212154,
          212153,
          212151,
          212150
        )
      )
      and (not "tasks"."ready_to_execute" = true)
      AND id in (
        select
          task_id
        from
          wp2
      )
    )
),
"inner_tasks_query" as (
  select
    *,
    "team_name" as "main_group_sort_value",
    "route_start_time" as "secondary_group_sort_value"
  from
    (
      select
        "tasks"."id",
        "users"."name" as "user_name",
        "users"."id" as "user_id",
        "teams"."name" as "team_name",
        "teams"."id" as "team_id",
        "tasks"."run_id" as "route_id",
        CASE
          WHEN runs.id is null THEN null
          WHEN planned_routes.title IS NULL
          AND service_areas.name is NULL THEN concat('Route-', runs.id)
          WHEN planned_routes.title IS NOT NULL
          AND service_areas.name is not null THEN concat(planned_routes.title, '-', service_areas.name)
          WHEN planned_routes.title IS NOT NULL THEN planned_routes.title
          ELSE service_areas.name
        END as route_name,
        CAST(
          COALESCE(runs.started_at, runs.scheduled_start_time) AS TIMESTAMP
        ) as route_start_time
      from
        base_tasks as "tasks"
        left join "runs" on "runs"."id" = "tasks"."run_id"
        and runs.merchant_id = 2288
        left join "users" on "users"."id" = "tasks"."user_id"
        and users.merchant_id = 2288
        and driver = true
        left join "planned_routes" on "runs"."planned_route_id" = "planned_routes"."id"
        and planned_routes.merchant_id = 2288
        left join "service_areas" on "runs"."service_area_id" = "service_areas"."id"
        and service_areas.merchant_id = 2288
        left join "teams" on "teams"."id" = "tasks"."team_id"
        and teams.merchant_id = 2288
    ) as "tasks"
)
select
  *,
  "team_name" as "main_group_sort_value",
  "route_start_time" as "secondary_group_sort_value"
from
  (
    select
      "team_name",
      max(team_id) as team_id,
      "route_start_time",
      max(route_name) as route_name,
      max(route_id) as route_id,
      count(*) as count_per_group
    from
      "inner_tasks_query"
    group by
      "team_name",
      "team_id",
      "route_start_time",
      "route_id"
    order by
      "team_name" asc,
      "team_id" asc,
      "route_start_time" asc,
      "route_id" asc
  ) as "subquery"
limit
  100;

'''
iterations = 100
concurrency = 2

[[queries]]
name = "BBuy all teams 24 hours - task"
statement = '''
with wp2 as (
  select
    task_id,
    no_earlier_than
  from
    way_points wp
  where
    merchant_id = 2288
    AND position = 2
    and (
      (
        "wp"."no_earlier_than" is not null
        or "wp"."no_later_than" is not null
      )
      and (
        "wp"."no_earlier_than" is null
        or "wp"."no_earlier_than" >= '2025-09-23T04:00:00.000Z'
      )
      and (
        "wp"."no_later_than" is null
        or "wp"."no_later_than" <= '2025-09-24T03:59:59.999Z'
      )
    )
    or (
      "wp"."scheduled_at" is not null
      and "wp"."no_earlier_than" is null
      and "wp"."no_later_than" is null
      and "wp"."scheduled_at" >= '2025-09-23T04:00:00.000Z'
      and "wp"."scheduled_at" <= '2025-09-24T03:59:59.999Z'
    )
),
base_tasks as (
  select
    id,
    run_id,
    team_id,
    user_id
  from
    tasks
  where
    (
      "tasks"."merchant_id" = 2288
      and "tasks"."delete_at" is null
      and (
        "tasks"."group_uuid" is null
        or (
          "tasks"."group_uuid" is not null
          and "tasks"."group_leader_id" is null
        )
      )
      and "tasks"."status" in (0, 1, 2, 3, 5, 6, 9, 10)
      and (
        "tasks"."team_id" is null
        or "tasks"."team_id" in (
          217228,
          217478,
          214208,
          213291,
          221926,
          214691,
          212372,
          217207,
          214761,
          212251,
          215508,
          214646,
          212247,
          214642,
          212246,
          214640,
          212245,
          214639,
          214759,
          214757,
          212363,
          214755,
          212361,
          212359,
          217203,
          212355,
          214752,
          214629,
          214631,
          212353,
          212352,
          212222,
          215485,
          217164,
          212265,
          214746,
          212340,
          214740,
          214739,
          214737,
          217477,
          214736,
          212338,
          214735,
          217202,
          212337,
          214734,
          215592,
          214727,
          212332,
          214725,
          214169,
          214171,
          212330,
          212329,
          217196,
          215589,
          215662,
          214723,
          212328,
          217195,
          214721,
          215581,
          214720,
          214719,
          217190,
          217189,
          214718,
          212326,
          217188,
          214172,
          212324,
          215575,
          217142,
          212263,
          212262,
          217141,
          212323,
          217185,
          214701,
          214698,
          212208,
          217160,
          214697,
          212321,
          214696,
          214173,
          212319,
          217184,
          212318,
          214695,
          212317,
          217183,
          214694,
          214182,
          217182,
          212257,
          217138,
          212207,
          215481,
          212204,
          217159,
          212203,
          214613,
          215475,
          212196,
          214612,
          214167,
          212195,
          212194,
          215474,
          212193,
          215473,
          212312,
          217181,
          212310,
          217180,
          214690,
          214689,
          212307,
          217178,
          212306,
          214685,
          215566,
          212303,
          217177,
          212302,
          217176,
          214676,
          214670,
          212190,
          217154,
          212187,
          215562,
          215561,
          215560,
          215559,
          214667,
          215558,
          212183,
          217151,
          212182,
          212181,
          212180,
          214597,
          212179,
          212178,
          212177,
          212176,
          217150,
          212174,
          214591,
          212169,
          214588,
          212168,
          214587,
          212296,
          217172,
          212295,
          212294,
          215552,
          212293,
          217171,
          212292,
          215549,
          212291,
          212167,
          214586,
          212166,
          214585,
          214654,
          215541,
          212290,
          214650,
          212165,
          214584,
          215538,
          214181,
          214180,
          214179,
          214178,
          214177,
          214175,
          215510,
          212252,
          212277,
          214814,
          212274,
          214783,
          212379,
          212378,
          212376,
          214828,
          212155,
          212152,
          215465,
          212249,
          212297,
          212228,
          212308,
          212300,
          212339,
          215010,
          215502,
          212164,
          214623,
          220867,
          214717,
          215483,
          212305,
          214637,
          214748,
          214745,
          214617,
          214603,
          213286,
          215469,
          214772,
          214773,
          214168,
          217193,
          214771,
          217186,
          214839,
          214705,
          214707,
          215582,
          215520,
          214809,
          212345,
          212304,
          217956,
          217957,
          214662,
          214656,
          212218,
          214820,
          211594,
          214665,
          212236,
          211592,
          212235,
          217958,
          214578,
          214788,
          212309,
          212333,
          214806,
          214635,
          214621,
          214747,
          214838,
          214687,
          214683,
          214835,
          212162,
          214804,
          214797,
          214785,
          214781,
          214700,
          214648,
          214583,
          214821,
          214641,
          214758,
          214624,
          194513,
          214183,
          214184,
          217208,
          217169,
          217206,
          217205,
          217204,
          217166,
          217201,
          217200,
          217199,
          217198,
          217132,
          217197,
          217194,
          217192,
          217191,
          217187,
          217162,
          217161,
          217139,
          217158,
          217175,
          217157,
          217156,
          217155,
          217152,
          217174,
          217173,
          217149,
          217170,
          217135,
          217129,
          217148,
          217145,
          217179,
          217168,
          217167,
          217165,
          217163,
          217153,
          217147,
          217144,
          217143,
          217140,
          217137,
          217136,
          217134,
          217133,
          217131,
          217130,
          216970,
          216972,
          216971,
          213664,
          211595,
          211593,
          211600,
          212266,
          214592,
          214593,
          214607,
          215772,
          194509,
          214770,
          214769,
          214659,
          214645,
          214742,
          212298,
          214630,
          214768,
          214628,
          215517,
          215638,
          215637,
          215636,
          215635,
          215634,
          215621,
          215620,
          215619,
          215244,
          215601,
          215600,
          215599,
          215598,
          215597,
          215596,
          215595,
          215594,
          215593,
          215591,
          215590,
          215588,
          215587,
          215586,
          215585,
          215584,
          215583,
          215580,
          215579,
          215578,
          215577,
          215576,
          215574,
          215573,
          215572,
          215571,
          215102,
          215094,
          214743,
          214744,
          214616,
          214576,
          214581,
          214780,
          212375,
          212374,
          214751,
          214680,
          214807,
          214802,
          214795,
          214799,
          214786,
          214778,
          214777,
          212264,
          214811,
          214810,
          214808,
          214805,
          214803,
          214801,
          214800,
          214798,
          214796,
          214794,
          214793,
          214792,
          214791,
          214790,
          214789,
          214787,
          214784,
          214782,
          214779,
          214776,
          214775,
          214774,
          214766,
          214765,
          214764,
          214763,
          214762,
          214760,
          214756,
          214754,
          214753,
          214750,
          214749,
          214741,
          214738,
          214733,
          214732,
          214731,
          214730,
          214729,
          214728,
          214726,
          214724,
          214722,
          214716,
          214715,
          214714,
          214713,
          214712,
          214711,
          214710,
          214709,
          214708,
          214767,
          217146,
          217128,
          212270,
          221450,
          212299,
          212316,
          212313,
          212289,
          212197,
          214706,
          214704,
          214703,
          214699,
          214693,
          214692,
          214688,
          214686,
          214684,
          214682,
          214681,
          214679,
          214678,
          214677,
          214675,
          214674,
          214673,
          214672,
          214671,
          214669,
          214668,
          214666,
          214664,
          214663,
          214661,
          214660,
          214658,
          214657,
          214655,
          214653,
          214652,
          214651,
          214649,
          214647,
          214644,
          214643,
          214638,
          214636,
          214634,
          214633,
          214627,
          214626,
          214625,
          214622,
          214620,
          214619,
          214618,
          214615,
          214614,
          214611,
          214610,
          214609,
          214608,
          214605,
          214604,
          214601,
          214600,
          214599,
          214598,
          214596,
          214595,
          214594,
          214590,
          214589,
          214579,
          214577,
          214575,
          214574,
          214573,
          214572,
          214170,
          214174,
          214186,
          214185,
          213648,
          213646,
          214176,
          213287,
          212552,
          213937,
          213282,
          213292,
          212550,
          213535,
          213543,
          213935,
          213533,
          212549,
          212551,
          213293,
          213934,
          213290,
          213284,
          213288,
          212548,
          213294,
          213289,
          213536,
          213540,
          213539,
          213537,
          211590,
          211589,
          211587,
          211588,
          211601,
          211596,
          211597,
          194517,
          213936,
          213647,
          213538,
          213532,
          212547,
          213948,
          212163,
          213542,
          213534,
          213665,
          213541,
          213531,
          213530,
          213529,
          213528,
          213527,
          213526,
          213525,
          213283,
          213285,
          215570,
          215569,
          215568,
          215567,
          215565,
          215564,
          215563,
          215557,
          215556,
          215555,
          215554,
          215553,
          215551,
          215550,
          215548,
          215547,
          215546,
          215545,
          215544,
          215543,
          215542,
          215540,
          215539,
          215537,
          215536,
          215535,
          215534,
          215533,
          215532,
          215531,
          215530,
          215529,
          215528,
          215527,
          215526,
          215525,
          215524,
          215523,
          215522,
          215521,
          215519,
          215518,
          215516,
          215515,
          215514,
          215513,
          215512,
          215511,
          215509,
          215507,
          215506,
          215505,
          215504,
          215503,
          215501,
          215500,
          215499,
          215498,
          215497,
          215496,
          215495,
          215494,
          215493,
          215492,
          215491,
          215490,
          215489,
          215488,
          215487,
          215486,
          215484,
          215482,
          215480,
          215479,
          215478,
          215477,
          215476,
          215472,
          215471,
          215470,
          215468,
          215467,
          215466,
          214582,
          214702,
          214580,
          211598,
          215101,
          215100,
          215099,
          215098,
          215097,
          215096,
          215095,
          214602,
          214632,
          214606,
          214843,
          214842,
          214841,
          214840,
          214837,
          214836,
          214834,
          214833,
          214832,
          214831,
          214830,
          214829,
          214827,
          214826,
          214825,
          214824,
          214823,
          214822,
          214819,
          214818,
          214817,
          214816,
          214815,
          214813,
          214812,
          211591,
          212273,
          212380,
          212377,
          212373,
          212371,
          212370,
          212369,
          212368,
          212367,
          212366,
          212365,
          212364,
          212362,
          212360,
          212358,
          212357,
          212356,
          212354,
          212351,
          212350,
          212349,
          212347,
          212346,
          212344,
          212343,
          212342,
          212341,
          212336,
          212335,
          212334,
          212331,
          212327,
          212325,
          212322,
          212320,
          212315,
          212314,
          212311,
          212301,
          212288,
          212287,
          212286,
          212285,
          212284,
          212283,
          212282,
          212281,
          212280,
          212279,
          212278,
          212276,
          212275,
          212272,
          212271,
          212269,
          212268,
          212267,
          212261,
          212260,
          212259,
          212258,
          212256,
          212255,
          212254,
          212253,
          212250,
          212248,
          212244,
          212243,
          212242,
          212241,
          212240,
          212239,
          212238,
          212237,
          212234,
          212233,
          212232,
          212231,
          212230,
          212229,
          212227,
          212226,
          212225,
          212224,
          212223,
          212221,
          212220,
          212219,
          212217,
          212216,
          212215,
          212214,
          212213,
          212212,
          212211,
          212210,
          212209,
          212206,
          212205,
          212202,
          212201,
          212200,
          212199,
          212198,
          212192,
          212191,
          212189,
          212188,
          212186,
          212185,
          212184,
          212175,
          212173,
          212172,
          212171,
          212170,
          212161,
          212160,
          212159,
          212158,
          212157,
          212156,
          212154,
          212153,
          212151,
          212150
        )
      )
      and (not "tasks"."ready_to_execute" = true)
      AND id in (
        select
          task_id
        from
          wp2
      )
    )
)
select
  *,
  "time_window" as "sort_value",
  "team_name" as "main_group_sort_value",
  "route_start_time" as "secondary_group_sort_value"
from
  (
    select
      "tasks"."id",
      "users"."name" as "user_name",
      "users"."id" as "user_id",
      "teams"."name" as "team_name",
      "teams"."id" as "team_id",
      "tasks"."run_id" as "route_id",
      CASE
        WHEN runs.id is null THEN null
        WHEN planned_routes.title IS NULL
        AND service_areas.name is NULL THEN concat('Route-', runs.id)
        WHEN planned_routes.title IS NOT NULL
        AND service_areas.name is not null THEN concat(planned_routes.title, '-', service_areas.name)
        WHEN planned_routes.title IS NOT NULL THEN planned_routes.title
        ELSE service_areas.name
      END as route_name,
      CAST(
        COALESCE(runs.started_at, runs.scheduled_start_time) AS TIMESTAMP
      ) as route_start_time,
      wp2.no_earlier_than as "time_window"
    from
      base_tasks as "tasks"
      left join "runs" on "runs"."id" = "tasks"."run_id"
      and runs.merchant_id = 2288
      left join "users" on "users"."id" = "tasks"."user_id"
      and users.merchant_id = 2288
      and driver = true
      left join "planned_routes" on "runs"."planned_route_id" = "planned_routes"."id"
      and planned_routes.merchant_id = 2288
      left join "service_areas" on "runs"."service_area_id" = "service_areas"."id"
      and service_areas.merchant_id = 2288
      left join "teams" on "teams"."id" = "tasks"."team_id"
      and teams.merchant_id = 2288
      left join "wp2" on "wp2"."task_id" = "tasks"."id"
    order by
      "time_window" asc,
      "tasks"."id" asc
    limit
      100
  ) as "tasks"
'''
iterations = 100
concurrency = 2

[[queries]]
name = "BBuy Shlomi hack - task_group"
statement = '''
with "run_ids" as (
  select
    "runs"."id"
  from
    "runs"
  where
    (
      "runs"."merchant_id" = 2288
      and "runs"."delete_at" is null
      and "runs"."team_id" in (
        213290,
        212548,
        213532,
        213531,
        217140,
        213283,
        213540,
        213293,
        213525,
        213535,
        213538,
        213934,
        213288,
        213539,
        213289
      )
      and "runs"."ready_to_execute" = true
    )
),
base_tasks as (
  select
    id,
    run_id,
    team_id,
    user_id,
    external_id
  from
    tasks
  where
    merchant_id = 2288
    and delete_at is null
    and status in (0, 1, 2, 3, 5, 6, 9, 10)
    and (
      group_uuid is null
      or (
        group_uuid is not null
        and group_leader_id is null
      )
    )
    and run_id in (
      select
        id
      from
        run_ids
    )
),
"inner_tasks_query" as (
  select
    *,
    "external_id" as "sort_value",
    "team_name" as "main_group_sort_value",
    "route_start_time" as "secondary_group_sort_value"
  from
    (
      select
        "tasks"."id",
        "users"."name" as "user_name",
        "users"."id" as "user_id",
        "teams"."name" as "team_name",
        "teams"."id" as "team_id",
        "tasks"."run_id" as "route_id",
        CASE
          WHEN runs.id is null THEN null
          WHEN planned_routes.title IS NULL
          AND service_areas.name is NULL THEN concat('Route-', runs.id)
          WHEN planned_routes.title IS NOT NULL
          AND service_areas.name is not null THEN concat(planned_routes.title, '-', service_areas.name)
          WHEN planned_routes.title IS NOT NULL THEN planned_routes.title
          ELSE service_areas.name
        END as route_name,
        cast(
          COALESCE(runs.started_at, runs.scheduled_start_time) as timestamp
        ) as route_start_time,
        "tasks"."external_id"
      from
        base_tasks as "tasks"
        inner join "runs" on "runs"."id" = "tasks"."run_id"
        and runs.merchant_id = 2288
        left join "way_points" as "wp2" on "wp2"."task_id" = "tasks"."id"
        and "wp2"."position" = 2
        and wp2.merchant_id = 2288
        and wp2.eta is not null
        and wp2.eta >= '2025-09-21T05:00:00.000Z'
        and wp2.eta <= '2025-09-26T04:59:59.999Z'
        left join "users" on "users"."id" = "tasks"."user_id"
        and users.merchant_id = 2288
        and driver = true
        left join "planned_routes" on "runs"."planned_route_id" = "planned_routes"."id"
        and planned_routes.merchant_id = 2288
        left join "service_areas" on "runs"."service_area_id" = "service_areas"."id"
        and service_areas.merchant_id = 2288
        left join "teams" on "teams"."id" = "tasks"."team_id"
        and teams.merchant_id = 2288
      where
        (
          COALESCE(runs.started_at, runs.scheduled_start_time) >= '2025-09-21T05:00:00.000Z'
          and COALESCE(runs.started_at, runs.scheduled_start_time) <= '2025-09-26T04:59:59.999Z'
        )
        or (wp2.eta is not null)
    ) as "tasks"
)
select
  *,
  "team_name" as "main_group_sort_value",
  "route_start_time" as "secondary_group_sort_value"
from
  (
    select
      "team_name",
      max(team_id) as team_id,
      "route_start_time",
      max(route_name) as route_name,
      max(route_id) as route_id,
      count(*) as count_per_group
    from
      "inner_tasks_query"
    group by
      "team_name",
      "team_id",
      "route_start_time",
      "route_id"
    order by
      "team_name" asc,
      "team_id" asc,
      "route_start_time" asc,
      "route_id" asc
  ) as "subquery"
limit
  150

'''
iterations = 100
concurrency = 2
